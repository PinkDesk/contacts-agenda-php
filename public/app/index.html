<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contacts SPA</title>

    <!-- Vue.js (Production Build) -->
    <script src="https://unpkg.com/vue@3.5.24/dist/vue.global.prod.js"></script>

    <!-- Global and module-specific styles -->
    <link rel="stylesheet" href="../assets/css/global.css">
</head>
<body>

<div id="app" class="container">
    <h1>Contacts SPA</h1>

    <!-- Display API or form error messages -->
    <div v-if="errorMessage" class="error">{{ errorMessage }}</div>
    <div v-if="successMessage" class="success">{{ successMessage }}</div>

    <!-- Contact Form -->
    <div>
        <h2>{{ form.id ? 'Edit Contact' : 'Add Contact' }}</h2>

        <form @submit.prevent="saveContact">
            <input type="hidden" v-model="form.id">

            <label>Name:</label>
            <input type="text" v-model="form.name">

            <label>Email:</label>
            <input type="email" v-model="form.email">

            <label>Address:</label>
            <input type="text" v-model="form.address">

            <label>Phones:</label>
            <div id="phones-container">
                <div
                    v-for="(phone, index) in form.phones"
                    :key="index"
                    class="phone-field"
                >
                    <input
                        type="text"
                        v-model="form.phones[index]"
                        @input="maskPhone(index)"
                        :class="{ 'invalid': !validatePhone(index) }"
                        placeholder="(99) 99999-9999"
                        required
                    >
                    <button class="delete" type="button" @click="removePhone(index)">Remove</button>
                </div>
            </div>

            <button type="button" @click="addPhone">Add Phone</button>
            <br><br>

            <button type="submit">{{ form.id ? 'Update' : 'Save' }}</button>
            <button class="delete" type="button" @click="resetForm">Reset</button>
        </form>
    </div>

    <hr>

    <!-- Contacts List -->
    <h2>Contacts List</h2>

    <table v-if="contacts.length">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Address</th>
                <th>Phones</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="contact in contacts" :key="contact.id">
                <td>{{ contact.name }}</td>
                <td>{{ contact.email }}</td>
                <td>{{ contact.address }}</td>
                <td>
                    <span v-for="(p, i) in contact.phones" :key="i">
                        {{ formatPhoneForInput(p.phone) }}{{ i < contact.phones.length - 1 ? ', ' : '' }}
                    </span>
                </td>
                <td>
                    <button @click="editContact(contact)">Edit</button>
                    <button @click="deleteContact(contact.id)" class="delete">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>
    <div v-else>No contacts found.</div>

    <!-- Pagination -->
    <div class="pagination" v-if="totalPages > 1">
        <button @click="goToPage(currentPage - 1)" :disabled="currentPage === 1">Previous</button>
        <span>Page {{ currentPage }} of {{ totalPages }}</span>
        <button @click="goToPage(currentPage + 1)" :disabled="currentPage === totalPages">Next</button>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      contacts: [],
      errorMessage: '',
      successMessage: '',
      form: { id: '', name: '', email: '', address: '', phones: [''] },
      currentPage: 1,
      perPage: 10,
      totalPages: 1,
      sortAsc: true
    };
  },

  methods: {
    /**
     * Format raw phone for input mask (used for display & edit)
     * Supports +55XXXXXXXXXXX or XXXXXXXXXXX
     */
    formatPhoneForInput(raw) {
      let v = raw.toString().replace(/[^\d]/g, '');
      if (raw.startsWith('+55') && v.startsWith('55')) {
        v = v.slice(2);
      }

      if (v.length > 10) {
        // Mobile 11 digits
        v = v.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
      } else if (v.length > 5) {
        // Landline 10 digits
        v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
      } else if (v.length > 2) {
        v = v.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
      } else {
        v = v.replace(/^(\d*)/, '($1');
      }
      return v;
    },

    /**
     * Apply phone mask while typing
     */
    maskPhone(index) {
      let v = this.form.phones[index].replace(/[^\d]/g, '');
      if (v.length > 10) {
        v = v.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
      } else if (v.length > 5) {
        v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
      } else if (v.length > 2) {
        v = v.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
      } else {
        v = v.replace(/^(\d*)/, '($1');
      }
      this.form.phones[index] = v;
    },

    /**
     * Validate a single phone field
     */
    validatePhone(index) {
      const pattern = /^\(\d{2}\) \d{4,5}-\d{4}$/;
      return pattern.test(this.form.phones[index]);
    },

    /**
     * Validate all phones
     */
    validateAllPhones() {
      for (let i = 0; i < this.form.phones.length; i++) {
        if (!this.validatePhone(i)) {
          this.errorMessage = `Phone #${i+1} is invalid. Format: (99) 99999-9999`;
          return false;
        }
      }
      this.errorMessage = '';
      return true;
    },

    addPhone() { this.form.phones.push(''); },
    removePhone(index) { this.form.phones.splice(index, 1); },
    resetForm() { this.form = { id: '', name: '', email: '', address: '', phones: [''] }; this.errorMessage = ''; this.successMessage = ''; },

    /**
     * Populate form for editing (applies mask automatically)
     */
    editContact(contact) {
      this.form = {
        id: contact.id,
        name: contact.name,
        email: contact.email,
        address: contact.address,
        phones: contact.phones.length ? contact.phones.map(p => this.formatPhoneForInput(p.phone)) : ['']
      };
      this.errorMessage = '';
      this.successMessage = '';
    },

    /**
     * Save contact
     */
    saveContact() {
      if (!this.validateAllPhones()) return;

      const method = this.form.id ? 'update' : 'create';
      const idQuery = this.form.id ? '&id=' + this.form.id : '';

      fetch(`/api.php?method=${method}${idQuery}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.form)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          this.successMessage = data.message || 'Contact saved successfully!';
          this.resetForm();
          this.fetchContacts(this.currentPage);
        } else {
          this.errorMessage = data.message || 'Failed to save contact.';
        }
      })
      .catch(err => {
        this.errorMessage = 'Error connecting to API.';
        console.error(err);
      });
    },

    deleteContact(id) {
      if (!confirm('Are you sure you want to delete this contact?')) return;
      fetch(`/api.php?method=delete&id=${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            this.successMessage = data.message || 'Contact deleted!';
            this.fetchContacts(this.currentPage);
          } else {
            this.errorMessage = data.message || 'Failed to delete contact.';
          }
        })
        .catch(err => {
          this.errorMessage = 'Error connecting to API.';
          console.error(err);
        });
    },

    fetchContacts(page = 1) {
      this.currentPage = page;
      fetch(`/api.php?method=list&page=${page}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            this.contacts = data.data;
            const totalRecords = data.total || data.data.length;
            this.totalPages = Math.ceil(totalRecords / this.perPage);
            this.contacts.sort((a, b) => {
              const nameA = a.name.toLowerCase();
              const nameB = b.name.toLowerCase();
              return this.sortAsc ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
            });
          } else {
            this.errorMessage = 'Failed to fetch contacts.';
          }
        })
        .catch(err => {
          this.errorMessage = 'Error connecting to API.';
          console.error(err);
        });
    },

    goToPage(page) { if (page >= 1 && page <= this.totalPages) this.fetchContacts(page); },
    toggleSort() { this.sortAsc = !this.sortAsc; this.contacts.reverse(); }
  },

  mounted() {
    this.fetchContacts();
  }

}).mount('#app');
</script>

</body>
</html>
