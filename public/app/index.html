<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contacts SPA</title>

    <!-- Vue.js (Production Build) -->
    <script src="https://unpkg.com/vue@3.5.24/dist/vue.global.prod.js"></script>

    <!-- Global and module-specific styles -->
    <link rel="stylesheet" href="../assets/css/global.css">
</head>
<body>

<div id="app" class="container">
    <h1>Contacts SPA</h1>

    <!-- Display API or form error messages -->
    <div v-if="errorMessage" class="error">{{ errorMessage }}</div>

    <!-- Display success messages -->
    <div v-if="successMessage" class="success">{{ successMessage }}</div>

    <!-- =========================== -->
    <!-- Contact Form (Create / Edit) -->
    <!-- =========================== -->
    <div>
        <!-- Title changes depending on whether an ID exists -->
        <h2>{{ form.id ? 'Edit Contact' : 'Add Contact' }}</h2>

        <!-- Form submission triggers saveContact() -->
        <form @submit.prevent="saveContact">
            <input type="hidden" v-model="form.id">

            <!-- Name Field -->
            <label>Name:</label>
            <input type="text" v-model="form.name">

            <!-- Email Field -->
            <label>Email:</label>
            <input type="email" v-model="form.email">

            <!-- Address Field -->
            <label>Address:</label>
            <input type="text" v-model="form.address">

            <!-- Dynamic Phone List -->
            <label>Phones:</label>
            <div id="phones-container">
                <!-- Iterate over dynamic phone inputs -->
                <div
                    v-for="(phone, index) in form.phones"
                    :key="index"
                    class="phone-field"
                >
                    <!-- Two-way binding for each phone -->
                    <input type="text" v-model="form.phones[index]">

                    <!-- Remove phone row -->
                    <button class="delete" type="button" @click="removePhone(index)">Remove</button>
                </div>
            </div>

            <!-- Add new phone input -->
            <button type="button" @click="addPhone">Add Phone</button>
            <br><br>

            <!-- Submit and Reset Buttons -->
            <button type="submit">{{ form.id ? 'Update' : 'Save' }}</button>
            <button class="delete" type="button" @click="resetForm">Reset</button>
        </form>
    </div>

    <hr>

    <!-- =========================== -->
    <!-- Contacts Table (List View) -->
    <!-- =========================== -->
    <h2>Contacts List</h2>

    <!-- Render table only if contacts exist -->
    <table v-if="contacts.length">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Address</th>
                <th>Phones</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            <!-- Loop through contacts (one row per contact) -->
            <tr v-for="contact in contacts" :key="contact.id">
                <td>{{ contact.name }}</td>
                <td>{{ contact.email }}</td>
                <td>{{ contact.address }}</td>
                <td>
                    <!-- Display all phones separated by comma -->
                    <span
                        v-for="(p, i) in contact.phones"
                        :key="i"
                    >
                        {{ p.phone }}{{ i < contact.phones.length - 1 ? ', ' : '' }}
                    </span>
                </td>

                <!-- Edit and Delete actions -->
                <td>
                    <button @click="editContact(contact)">Edit</button>
                    <button @click="deleteContact(contact.id)" class="delete">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Fallback if no contacts are found -->
    <div v-else>No contacts found.</div>

    <!-- ================ -->
    <!-- Pagination Block -->
    <!-- ================ -->
    <div class="pagination" v-if="totalPages > 1">
        <button
            @click="goToPage(currentPage - 1)"
            :disabled="currentPage === 1"
        >
            Previous
        </button>

        <span>Page {{ currentPage }} of {{ totalPages }}</span>

        <button
            @click="goToPage(currentPage + 1)"
            :disabled="currentPage === totalPages"
        >
            Next
        </button>
    </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      // Loaded contacts for current page
      contacts: [],

      // Feedback message handlers
      errorMessage: '',
      successMessage: '',

      // Contact form (used for both create and edit)
      form: { id: '', name: '', email: '', address: '', phones: [''] },

      // Pagination control
      currentPage: 1,
      perPage: 10,
      totalPages: 1,

      // Sorting direction (true = ascending)
      sortAsc: true
    };
  },

  methods: {
    /**
     * Fetch the list of contacts from the API.
     * Supports pagination and alphabetical sorting.
     */
    fetchContacts(page = 1) {
      this.currentPage = page;

      fetch(`/api.php?method=list&page=${page}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            this.contacts = data.data;

            // Determine total pages from server or fallback
            const totalRecords = data.total || data.data.length;
            this.totalPages = Math.ceil(totalRecords / this.perPage);

            // Alphabetical sorting by contact name
            this.contacts.sort((a, b) => {
              const nameA = a.name.toLowerCase();
              const nameB = b.name.toLowerCase();
              if (nameA < nameB) return this.sortAsc ? -1 : 1;
              if (nameA > nameB) return this.sortAsc ? 1 : -1;
              return 0;
            });
          } else {
            this.errorMessage = 'Failed to fetch contacts.';
          }
        })
        .catch(err => {
          this.errorMessage = 'Error connecting to API.';
          console.error(err);
        });
    },

    /**
     * Navigate through paginated results.
     */
    goToPage(page) {
      if (page < 1 || page > this.totalPages) return;
      this.fetchContacts(page);
    },

    /**
     * Toggle alphabetical order between ascending and descending.
     */
    toggleSort() {
      this.sortAsc = !this.sortAsc;
      this.contacts.reverse();
    },

    /**
     * Add a new phone field to the form.
     */
    addPhone() {
      this.form.phones.push('');
    },

    /**
     * Remove a phone field by index.
     */
    removePhone(index) {
      this.form.phones.splice(index, 1);
    },

    /**
     * Reset the form to its initial state.
     */
    resetForm() {
      this.form = { id: '', name: '', email: '', address: '', phones: [''] };
      this.errorMessage = '';
      this.successMessage = '';
    },

    /**
     * Populate the form with the selected contact's data for editing.
     */
    editContact(contact) {
      this.form = {
        id: contact.id,
        name: contact.name,
        email: contact.email,
        address: contact.address,
        phones: contact.phones.map(p => p.phone)
      };

      this.errorMessage = '';
      this.successMessage = '';
    },

    /**
     * Create a new contact or update an existing one.
     */
    saveContact() {
      this.errorMessage = '';
      this.successMessage = '';

      const method = this.form.id ? 'update' : 'create';
      const idQuery = this.form.id ? '&id=' + this.form.id : '';

      fetch(`/api.php?method=${method}${idQuery}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.form)
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            this.successMessage = data.message || 'Contact saved!';
            this.resetForm();
            this.fetchContacts(this.currentPage);
          } else {
            this.errorMessage = data.message || 'Failed to save contact.';
          }
        })
        .catch(err => {
          this.errorMessage = 'Error connecting to API.';
          console.error(err);
        });
    },

    /**
     * Delete a contact after user confirmation.
     */
    deleteContact(id) {
      if (!confirm('Are you sure you want to delete this contact?')) return;

      fetch(`/api.php?method=delete&id=${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            this.successMessage = data.message || 'Contact deleted!';
            this.fetchContacts(this.currentPage);
          } else {
            this.errorMessage = data.message || 'Failed to delete contact.';
          }
        })
        .catch(err => {
          this.errorMessage = 'Error connecting to API.';
          console.error(err);
        });
    }
  },

  /**
   * Fetch contacts automatically when the component is mounted.
   */
  mounted() {
    this.fetchContacts();
  }
}).mount('#app');
</script>

</body>
</html>
